<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Persistent Petitioner</title>
  <style>
    :root { --bg: #0f1419; --surface: #1a2332; --border: #2d3a4d; --text: #e6edf3; --muted: #8b949e; --accent: #58a6ff; --success: #3fb950; --warning: #d29922; }
    * { box-sizing: border-box; }
    body { font-family: ui-monospace, monospace; background: var(--bg); color: var(--text); margin: 0; padding: 1rem; line-height: 1.5; }
    .container { max-width: 900px; margin: 0 auto; }
    h1 { font-size: 1.25rem; }
    .subtitle { color: var(--muted); font-size: 0.875rem; margin-bottom: 1.5rem; }
    .card { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 1rem; margin-bottom: 1rem; }
    .status { display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem; }
    .status-item { font-size: 0.8rem; padding: 0.25rem 0.5rem; border-radius: 4px; background: var(--border); }
    .status-item.ok { background: rgba(63, 185, 80, 0.2); color: var(--success); }
    .status-item.missing { background: rgba(210, 153, 34, 0.2); color: var(--warning); }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 0.5rem 0.75rem; text-align: left; border-bottom: 1px solid var(--border); }
    th { color: var(--muted); font-size: 0.8rem; }
    a { color: var(--accent); }
    form { display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: flex-end; margin-bottom: 1rem; }
    input, button { padding: 0.4rem 0.6rem; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text); }
    button.primary { background: var(--accent); color: var(--bg); }
    button.danger { background: #f85149; color: #fff; border: none; }
    .empty { color: var(--muted); font-style: italic; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Persistent Petitioner</h1>
    <p class="subtitle">Manage petition types and view processed petitions. Filters pick simple petitions only.</p>
    <div id="status" class="status"></div>
    <div class="card">
      <div class="section-title">Petition Types</div>
      <form id="addTypeForm">
        <input name="name" placeholder="Type name" required size="18">
        <input name="url_pattern" placeholder="URL pattern (optional)" size="25">
        <button type="submit" class="primary">Add type</button>
      </form>
      <div id="typeMsg" class="msg"></div>
      <div id="typeErr" class="err"></div>
      <table>
        <thead><tr><th>Name</th><th>URL pattern</th><th>Enabled</th><th></th></tr></thead>
        <tbody id="types"></tbody>
      </table>
    </div>
    <div class="card">
      <div class="section-title">Recently Processed</div>
      <table>
        <thead><tr><th>Subject</th><th>Status</th><th>Date</th></tr></thead>
        <tbody id="processed"></tbody>
      </table>
    </div>
  </div>
  <script>
    const api = (path, opts = {}) => fetch(path, { ...opts, headers: { "Content-Type": "application/json", ...opts.headers } });
    function loadStatus() { api("/api/status").then(r => r.json()).then(s => {
      document.getElementById("status").innerHTML = [
        ["email_configured", "Email", s.email_configured],
        ["user_info_configured", "User info", s.user_info_configured],
      ].map(([k, label, ok]) => `<span class="status-item ${ok ? 'ok' : 'missing'}">${label}: ${ok ? 'OK' : 'Missing'}</span>`).join("");
    }); }
    function loadTypes() { api("/api/petition-types").then(r => r.json()).then(data => {
      const tbody = document.getElementById("types");
      tbody.innerHTML = !Array.isArray(data) || !data.length ? "<tr><td colspan='4' class='empty'>No petition types yet.</td></tr>" :
        data.map(t => `<tr><td>${t.name}</td><td>${t.url_pattern || "-"}</td><td>${t.enabled ? "Yes" : "No"}</td><td><button class="danger" onclick="delType(${t.id})">Delete</button></td></tr>`).join("");
    }); }
    function loadProcessed() { api("/api/processed?limit=20").then(r => r.json()).then(data => {
      const tbody = document.getElementById("processed");
      tbody.innerHTML = !Array.isArray(data) || !data.length ? "<tr><td colspan='3' class='empty'>No processed petitions yet.</td></tr>" :
        data.map(p => `<tr><td>${(p.subject || "").slice(0, 50)}</td><td>${p.status}</td><td>${p.signed_at ? new Date(p.signed_at).toLocaleString() : "-"}</td></tr>`).join("");
    }); }
    function delType(id) { api("/api/petition-types/" + id, { method: "DELETE" }).then(r => { if (r.ok) loadTypes(); }); }
    document.getElementById("addTypeForm").onsubmit = (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      api("/api/petition-types", { method: "POST", body: JSON.stringify({ name: fd.get("name"), url_pattern: fd.get("url_pattern") || null }) })
        .then(r => r.ok ? (e.target.reset(), loadTypes()) : r.json().then(j => { document.getElementById("typeErr").textContent = j.detail || "Failed"; }));
    };
    loadStatus(); loadTypes(); loadProcessed(); setInterval(loadProcessed, 30000);
  </script>
</body>
</html>
